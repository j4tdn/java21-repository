DROP DATABASE IF EXISTS karaoke;
CREATE DATABASE karaoke CHAR SET utf8mb4;
USE karaoke;

CREATE TABLE CUSTOMER
(
	CUSTOMER_ID VARCHAR(10) PRIMARY KEY,
    CUSTOMER_FULLNAME VARCHAR(50) NOT NULL,
    CUSTOMER_ADDRESS TEXT NOT NULL,
    CUSTOMER_PHONE VARCHAR(15) NOT NULL,
    CUSTOMER_TAX_CODE VARCHAR(20) NOT NULL
);

CREATE TABLE HOURLY_RATE
(
	HOURLY_RATE_ID VARCHAR(10) PRIMARY KEY,
    HOURLY_RATE_UNIT_PRICE FLOAT NOT NULL,
	HOURLY_RATE_DESCRIPTION VARCHAR(200) NOT NULL
);

CREATE TABLE ROOM
(
	ROOM_ID VARCHAR(10) PRIMARY KEY,
    ROOM_MAX_PEOPLE INT NOT NULL,
    ROOM_STATUS VARCHAR(100) NOT NULL,
	ROOM_DESCRIPTION VARCHAR(200) NOT NULL
);

CREATE TABLE SERVICE
(
	SERVICE_ID VARCHAR(10) PRIMARY KEY,
    SERVICE_FULLNAME VARCHAR(100) NOT NULL,
    SERVICE_UNIT_OF_MEASURE VARCHAR(100) NOT NULL,
	SERVICE_UNIT_PRICE FLOAT NOT NULL
);

CREATE TABLE BILL
(
	BILL_ID VARCHAR(10) PRIMARY KEY,
    BILL_CUSTOMER_ID VARCHAR(10) NOT NULL,
    BILL_ROOM_ID VARCHAR(10) NOT NULL,
    BILL_HOUR_RATE_ID VARCHAR(10) NOT NULL,
    BILL_START_TIME DATETIME,
    BILL_END_TIME DATETIME,
    BILL_STATUS VARCHAR(100) NOT NULL,
    
    CONSTRAINT FK_BILL_CUSTOMER FOREIGN KEY (BILL_CUSTOMER_ID) REFERENCES CUSTOMER(CUSTOMER_ID),
    CONSTRAINT FK_BILL_ROOM FOREIGN KEY (BILL_ROOM_ID) REFERENCES ROOM(ROOM_ID),
    CONSTRAINT FK_BILL_HOUR_RATE FOREIGN KEY (BILL_HOUR_RATE_ID) REFERENCES HOURLY_RATE(HOURLY_RATE_ID)
);

CREATE TABLE SERVICE_USAGE_DETAIL
(
	 SERVICE_USAGE_DETAIL_BILL_ID VARCHAR(10) NOT NULL,
     SERVICE_USAGE_DETAIL_SERVICE_ID VARCHAR(10) NOT NULL,
     SERVICE_USAGE_DETAIL_AMOUNT INT NOT NULL,
     
	 PRIMARY KEY (SERVICE_USAGE_DETAIL_BILL_ID, SERVICE_USAGE_DETAIL_SERVICE_ID),
     CONSTRAINT FK_SUD_BILL FOREIGN KEY (SERVICE_USAGE_DETAIL_BILL_ID) REFERENCES BILL(BILL_ID),
	 CONSTRAINT FK_SUD_SERVICE FOREIGN KEY (SERVICE_USAGE_DETAIL_SERVICE_ID) REFERENCES SERVICE(SERVICE_ID)
);

-- INSERT DATA
INSERT INTO CUSTOMER (CUSTOMER_ID, CUSTOMER_FULLNAME, CUSTOMER_ADDRESS, CUSTOMER_PHONE, CUSTOMER_TAX_CODE) VALUES
('KH001', 'Tran Van Nam', 'Hai Chau', '0905123456', '12345678'),
('KH002', 'Nguyen Mai Anh', 'Lien Chieu', '0905123457', '12345679'),
('KH003', 'Phan Hoai Lan Khue', 'Hoa Vang', '0905123458', '12345680'),
('KH004', 'Nguyen Hoai Nguyen', 'Hoa Cam', '0905123459', '12345681'),
('KH005', 'Le Truong Ngoc Anh', 'Hai Chau', '0905123460', '12345682');

INSERT INTO ROOM (ROOM_ID, ROOM_MAX_PEOPLE, ROOM_STATUS, ROOM_DESCRIPTION) VALUES
('VIP01', 5, 'Duoc su dung', 'phong vip'),
('P02', 10, 'Duoc su dung', 'phong binh thuong'),
('P03', 15, 'Duoc su dung', 'phong binh thuong'),
('VIP04', 20, 'Duoc su dung', 'phong vip'),
('P05', 25, 'Duoc su dung', 'phong binh thuong');

INSERT INTO SERVICE (SERVICE_ID, SERVICE_FULLNAME, SERVICE_UNIT_OF_MEASURE, SERVICE_UNIT_PRICE) VALUES
('DV01', 'Hat Dua', 'Bao', 5000),
('DV02', 'Trai cay', 'Dia', 30000),
('DV03', 'Bia', 'Lon', 35000),
('DV04', 'Nuoc Ngot', 'Chai', 10000),
('DV05', 'Ruou', 'Chai', 200000);

INSERT INTO HOURLY_RATE (HOURLY_RATE_ID, HOURLY_RATE_UNIT_PRICE, HOURLY_RATE_DESCRIPTION) VALUES
('MT01', 60000, 'Ap dung tu 6 gio den 17 gio'),
('MT02', 80000, 'Ap dung sau 17 gio den 22 gio'),
('MT03', 100000, 'Ap dung tu sau 22 gio den 6 gio sang');

INSERT INTO BILL (BILL_ID, BILL_CUSTOMER_ID, BILL_ROOM_ID, BILL_HOUR_RATE_ID, BILL_START_TIME, BILL_END_TIME, BILL_STATUS) VALUES
('HD001', 'KH001', 'VIP01', 'MT01', '2015-11-20 08:15', '2015-11-20 12:30', 'Da thanh toan'),
('HD002', 'KH002', 'P02', 'MT01', '2015-12-12 13:10', '2015-12-12 17:20', 'Chua thanh toan'),
('HD003', 'KH001', 'P02', 'MT01', '2015-10-15 12:12', '2015-10-15 16:30', 'Da thanh toan'),
('HD004', 'KH001', 'VIP01', 'MT03', '2015-09-20 18:30', '2015-09-20 21:00', 'Chua thanh toan'),
('HD005', 'KH001', 'P03', 'MT02', '2015-11-25 19:00', '2015-11-25 21:45', 'Thanh toan mot phan');
 
 INSERT INTO SERVICE_USAGE_DETAIL (SERVICE_USAGE_DETAIL_BILL_ID, SERVICE_USAGE_DETAIL_SERVICE_ID, SERVICE_USAGE_DETAIL_AMOUNT) VALUES
('HD001', 'DV01', 5),
('HD002', 'DV01', 8),
('HD002', 'DV02', 5),
('HD002', 'DV03', 2),
('HD003', 'DV04', 1),
('HD003', 'DV05', 6),
('HD004', 'DV01', 5),
('HD005', 'DV02', 3),
('HD005', 'DV03', 10),
('HD005', 'DV04', 2);

-- Câu 3
SELECT r.ROOM_ID, r.ROOM_DESCRIPTION, 
       SUM(TIMESTAMPDIFF(MINUTE, b.BILL_START_TIME, b.BILL_END_TIME)) TOTAL_USAGE_TIME
FROM BILL b
JOIN ROOM r ON b.BILL_ROOM_ID = r.ROOM_ID
WHERE b.BILL_START_TIME BETWEEN '2014-02-01' AND '2016-02-28'
GROUP BY r.ROOM_ID, r.ROOM_DESCRIPTION
ORDER BY TOTAL_USAGE_TIME DESC;
 
-- Câu 4: Liệt kê 2 dịch vụ được sử dụng nhiều nhất trong mỗi tháng từ 01.2014 đến 12.2016

SELECT 
	YEAR(b.BILL_START_TIME) AS YEAR,
	MONTH(b.BILL_START_TIME) AS MONTH,
	s.SERVICE_FULLNAME, 
	SUM(TIMESTAMPDIFF(MINUTE, b.BILL_START_TIME, b.BILL_END_TIME)) TOTAL_USAGE_TIME
FROM BILL b
JOIN SERVICE_USAGE_DETAIL sud ON b.BILL_ID = sud.SERVICE_USAGE_DETAIL_BILL_ID
JOIN SERVICE s ON sud.SERVICE_USAGE_DETAIL_SERVICE_ID = s.SERVICE_ID
WHERE b.BILL_START_TIME BETWEEN '2014-01-01' AND '2016-12-31'
GROUP BY YEAR(b.BILL_START_TIME), MONTH(b.BILL_START_TIME), s.SERVICE_ID;
  
-- Câu 5:
SELECT * 
  FROM ROOM 
 WHERE ROOM_ID LIKE 'vip%';