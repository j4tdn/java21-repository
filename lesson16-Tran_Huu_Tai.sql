-- Phần A. Phân tích và viết các lệnh để xây dựng cơ sở dữ liệu dựa vào mô tả phía trên
-- --
CREATE DATABASE CompanyManagement CHAR SET utf8mb4;
USE CompanyManagement;

DROP TABLE IF EXISTS T01_EMPLOYEE;
CREATE TABLE T01_EMPLOYEE (
    C01_EMPLOYEE_ID INT PRIMARY KEY AUTO_INCREMENT,
    C01_FULL_NAME VARCHAR(255) NOT NULL,
    C01_ADDRESS VARCHAR(255),
    C01_SALARY FLOAT NOT NULL,
    C01_BIRTH_DATE DATE,
    C01_GENDER ENUM('Male', 'Female'),
    C01_HIRE_DATE DATE NOT NULL,
    C01_DEPARTMENT_ID INT NOT NULL,
    C01_SUPERVISOR_ID INT NOT NULL,
    -- CONSTRAINT FK_EMPLOYEE_DEPARTMENT FOREIGN KEY (C01_DEPARTMENT_ID)
-- 									  REFERENCES  T02_DEPARTMENT(C02_DEPARTMENT_ID),
	CONSTRAINT FK_EMPLOYEE_SUPERVISOR FOREIGN KEY (C01_SUPERVISOR_ID)
									  REFERENCES  T01_EMPLOYEE(C01_EMPLOYEE_ID)
);

DROP TABLE IF EXISTS T02_DEPARTMENT;
CREATE TABLE T02_DEPARTMENT (
    C02_DEPARTMENT_ID INT PRIMARY KEY AUTO_INCREMENT,
    C02_DEPARTMENT_NAME VARCHAR(255) NOT NULL UNIQUE,
    C02_MANAGER_ID INT NOT NULL,
    C02_MANAGER_START_DATE DATE,
    CONSTRAINT FK_DEPARTMENT_EMPLOYEE FOREIGN KEY (C02_MANAGER_ID)
									  REFERENCES  T01_EMPLOYEE(C01_EMPLOYEE_ID)
);
ALTER TABLE T01_EMPLOYEE 
ADD CONSTRAINT FK_EMPLOYEE_DEPARTMENT FOREIGN KEY (C01_DEPARTMENT_ID) REFERENCES T02_DEPARTMENT(C02_DEPARTMENT_ID);

DROP TABLE IF EXISTS T03_PROJECT;
CREATE TABLE T03_PROJECT (
    C03_PROJECT_ID INT PRIMARY KEY AUTO_INCREMENT,
    C03_PROJECT_NAME VARCHAR(255) NOT NULL UNIQUE,
    C03_START_DATE DATE,
    C03_END_DATE DATE,
    C03_REVENUE FLOAT,
    C03_PROJECT_MANAGER_ID INT,
    CONSTRAINT FK_PROJECT_EMPLOYEE FOREIGN KEY (C03_PROJECT_MANAGER_ID)
								   REFERENCES  T01_EMPLOYEE(C01_EMPLOYEE_ID)
);

DROP TABLE IF EXISTS T04_EMPLOYEE_PROJECT;
CREATE TABLE T04_EMPLOYEE_PROJECT (
    C04_EMPLOYEE_ID INT,
    C04_PROJECT_ID INT,
    C04_HOURS_WORKED FLOAT,
    PRIMARY KEY (C04_EMPLOYEE_ID, C04_PROJECT_ID),
    CONSTRAINT FK_EMPLOYEE_PROJECT_EMPLOYEE FOREIGN KEY (C04_EMPLOYEE_ID)
											REFERENCES  T01_EMPLOYEE(C01_EMPLOYEE_ID),
	CONSTRAINT FK_EMPLOYEE_PROJECT_PROJECT FOREIGN KEY (C04_PROJECT_ID)
										   REFERENCES  T03_PROJECT(C03_PROJECT_ID)
);

DROP TABLE IF EXISTS T05_SUPERVISOR;
CREATE TABLE T05_SUPERVISOR (
    C05_EMPLOYEE_ID INT,
    C05_SUPERVISOR_ID INT,
    PRIMARY KEY (C05_EMPLOYEE_ID, C05_SUPERVISOR_ID),
    CONSTRAINT FK_SUPERVISOR_EMPLOYEE FOREIGN KEY (C05_EMPLOYEE_ID)
									  REFERENCES  T01_EMPLOYEE(C01_EMPLOYEE_ID),
	CONSTRAINT FK_SUPERVISOR_EMPLOYEE2 FOREIGN KEY (C05_SUPERVISOR_ID)
									  REFERENCES  T01_EMPLOYEE(C01_EMPLOYEE_ID)
);
-- --
-- Phần B. Viết các lệnh để tạo dữ liệu kiểm thử cho dự án
-- Yêu cầu: Ít nhất 5 dòng cho mỗi bảng dữ liệu
INSERT INTO T02_DEPARTMENT (C02_DEPARTMENT_NAME, C02_MANAGER_START_DATE) VALUES
('HR', '2020-01-01'),
('IT', '2019-01-01'),
('Finance', '2023-01-01'),
('Marketing', '2022-01-01'),
('Sales', '2022-01-01');

INSERT INTO T01_EMPLOYEE (C01_FULL_NAME, C01_ADDRESS, C01_SALARY, C01_GENDER, C01_BIRTH_DATE, C01_HIRE_DATE, C01_DEPARTMENT_ID) VALUES
('Nhan', 'Ha Noi', 60000, 'Male', '1980-01-15', '2010-06-01', 1),
('Phu', 'Hai Phong', 65000, 'Female', '1995-02-20', '2011-07-15', 2),
('Loc', 'Da Nang', 70000, 'Male', '1999-03-10', '2009-09-25', 3),
('Tam', 'Ha Tinh', 55000, 'Female', '1997-04-05', '2012-11-30', 4),
('Hai', 'Nghe An', 75000, 'Male', '1985-05-25', '2008-03-15', 5);

UPDATE T02_DEPARTMENT SET C02_MANAGER_ID = 1 WHERE C02_DEPARTMENT_ID = 1;
UPDATE T02_DEPARTMENT SET C02_MANAGER_ID = 2 WHERE C02_DEPARTMENT_ID = 2;
UPDATE T02_DEPARTMENT SET C02_MANAGER_ID = 3 WHERE C02_DEPARTMENT_ID = 3;
UPDATE T02_DEPARTMENT SET C02_MANAGER_ID = 4 WHERE C02_DEPARTMENT_ID = 4;
UPDATE T02_DEPARTMENT SET C02_MANAGER_ID = 5 WHERE C02_DEPARTMENT_ID = 5;

INSERT INTO T03_PROJECT (C03_PROJECT_NAME, C03_START_DATE, C03_END_DATE, C03_REVENUE, C03_PROJECT_MANAGER_ID) VALUES
('Project Alpha', '2023-01-01', '2023-06-01', 1000000, 1),
('Project Beta', '2023-02-01', '2023-07-01', 2000000, 2),
('Project Gamma', '2023-03-01', '2023-08-01', 1500000, 3),
('Project Delta', '2023-04-01', '2023-09-01', 2500000, 4),
('Project Epsilon', '2023-05-01', '2023-10-01', 3000000, 5);

INSERT INTO T04_EMPLOYEE_PROJECT (C04_EMPLOYEE_ID, C04_PROJECT_ID, C04_HOURS_WORKED) VALUES
(1, 1, 120),
(2, 2, 130),
(3, 3, 110),
(4, 4, 140),
(5, 5, 150),
(1, 2, 50),
(2, 3, 60),
(3, 4, 70),
(4, 5, 80),
(5, 1, 90);

INSERT INTO T05_SUPERVISOR (C05_EMPLOYEE_ID, C05_SUPERVISOR_ID) VALUES
(2, 1),
(3, 1),
(4, 2),
(5, 3),
(1, 5);

-- Phần C. Thực hiện truy vấn
-- 1. Liệt kê các dự án diễn ra trong năm *?* có số tiền thu được trên *?* triệu VND
SELECT *
FROM T03_PROJECT
WHERE YEAR(C03_START_DATE) = 2023 AND C03_REVENUE > 2300000;

-- 2. Liệt kê các nhân viên đã tham gia hơn ?*? giờ trong các dự án, hiển thị chi tiết số giờ trong mỗi
-- dự án mà nhân viên tham gia
SELECT e.C01_C01_FULL_NAME, p.C03_PROJECT_NAME, ep.C04_HOURS_WORKED
FROM T01_EMPLOYEE e
JOIN T04_EMPLOYEE_PROJECT ep ON e.C01_EMPLOYEE_ID = ep.C04_EMPLOYEE_ID
JOIN T03_PROJECT p ON ep.C04_PROJECT_ID = p.C03_PROJEC_ID
WHERE ep.C04_HOURS_WORKED > 100;

-- 3. Liệt kê các nhân viên có mức lương >= mức lương của người giám sát/quản lý trực tiếp nhân
-- viên đó
-- --
-- 4. Liệt kê các phòng ban có số lượng nhân viên lớn hơn *?*
-- --
-- 5. Liệt kê các nhân viên đã làm việc cho công ty hơn ?*? năm
-- --
-- 6. Liệt kê các nhân viên vừa là trưởng phòng ban, và là quản lý dự án
-- --
-- 7. Liệt kê các nhân viên quản lý nhiều hơn 1 dự án
-- --
-- 8. Mỗi khi nhân viên tham gia vào dự án chúng ta cần lưu lại thông tin hay còn được gọi là log để
-- biết nhân viên đó tham gia vào dự án vào thời gian nào
-- Mỗi khi nhân viên cập nhật số giờ tham gia dự án, ta cần lưu lại thông tin thời gian cập nhật khi
-- nào, số giờ tham gia cũ, số giờ tham gia mới
-- Công việc được thực hiện tự động khi dự dữ liệu được thêm, cập nhật